#include "../../plugin_api/HippoPlugin.h"
#include <stdlib.h>
#include <stdio.h>
#include <string.h>
//#include <unistd.h>
#include <math.h>
//#include "replayer/hvl_replay.h"

const int FREQ = 48000;
const int FRAME_SIZE = ((FREQ * 2) / 50);

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

struct sidReplayerData {
};

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

static const char* sid_info(void* userData) {
	return 0;
}

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

static const char* sid_track_info(void* userData) {
	return 0;
}

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

static const char* sid_supported_extensions() {
	return "sid";
}

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

static void* sid_create() {
	void* data = malloc(sizeof(struct sidReplayerData));
	memset(data, 0, sizeof(struct sidReplayerData));

	return data;
}

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

static int sid_destroy(void* user_data) {
	struct sidReplayerData* data = (struct sidReplayerData*)user_data;
	free(data);
	return 0;
}

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

static int sid_open(void* userData, const char* buffer) {
	/*
	// TODO: Add reader functions etc to be used instead of fopen as file may come from zip, etc

	FILE* file = fopen(buffer, "rb");
	fseek(file, 0, SEEK_END);
	size_t size = ftell(file);
	fseek(file, 0, SEEK_SET);

	song_data = malloc(size);
	fread(song_data, size, 1, file);

	struct sidReplayerData* replayerData = (struct sidReplayerData*)userData;
	replayerData->tune = hvl_load_ahx(song_data, size, 0, FREQ);
	free(song_data);
	*/

	return 0;
}

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

static int sid_close(void* userData) {
	return 0;
}

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

static int sid_read_data(void* userData, void* dest) {
	/*

	const float scale = 1.0f / 32768.0f;

	for (int i = 0; i < frames_decoded; ++i) {
		newDest[i] = ((float)temp_data[i]) * scale;
	}
	*/

	return 0;
}

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

static int sid_seek(void* userData, int ms) {
	return 0;
}

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

static int sid_frame_size(void* userData) {
	return FRAME_SIZE;
}

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

static HippoPlaybackPlugin g_sid_plugin = {
	1,
	sid_info,
	sid_track_info,
	sid_supported_extensions,
	sid_create,
	sid_destroy,
	sid_open,
	sid_close,
	sid_read_data,
	sid_seek,
	sid_frame_size,
};

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

HippoPlaybackPlugin* getPlugin() {
	return &g_sid_plugin;
}


