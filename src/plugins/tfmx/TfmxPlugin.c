#include "../../hippoplayer/plugin_api/HippoPlugin.h"
#include "src/tfmx.h"
#include "src/tfmx_iface.h"
#include <stdlib.h>
#include <stdio.h>
#include <string.h>

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

typedef struct TfmxReplayerData 
{
	void* tune;
} TfmxReplayerData;

static struct TfmxReplayerData g_replayerData;

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

static const char* tfmxInfo(void* userData)
{
	return 0;
}

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

static const char* tfmxTrackInfo(void* userData)
{
	return 0;
}

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

static const char** tfmxSupportedExtensions(void* userData)
{
	static const char* supportedFomats[] =
	{
		"tfmx",
		"TFX",
		0,
	};

	return supportedFomats;
}

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

static void* tfmxCreate()
{
	TfmxReplayerData* replayer;

	// TODO: supply custom allocator

	replayer = (TfmxReplayerData*)malloc(sizeof(struct TfmxReplayerData));
	memset(replayer, 0, sizeof(struct TfmxReplayerData));

	return replayer;
}

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

static int tfmxDestroy(void* userData)
{
	return 0;
}

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

static int tfmxOpen(void* userData, const char* buffer)
{
	if (LoadTFMXFile((char*)buffer) != 0)
	    return -1;

	TFMXSetSubSong(0);
    TFMXRewind();

	return 0;
}

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

static int tfmxClose(void* userData)
{
	return 0;
}

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

static int tfmxReadData(void* userData, HippoPlaybackBuffer* dest)
{
    (void)userData;
    long blocksize = tfmx_get_block_size();

    if (tfmx_try_to_make_block() >= 0)
    {	
	    tfmx_get_block(dest->data);
    }
	else
    {
        memset(dest->data, 0, blocksize);
    }

	return 0;
}

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

static int tfmxSeek(void* userData, int ms)
{
	return 0;
}

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

static int tfmxFrameSize(void* userData)
{
    return tfmx_get_block_size();
}

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

static HippoPlaybackPlugin g_tfmxPlugin = 
{
	1,
	tfmxInfo,
	tfmxTrackInfo,
	tfmxSupportedExtensions,
	tfmxCreate,
	tfmxDestroy,
	tfmxOpen,
	tfmxClose,
	tfmxReadData,
	tfmxSeek,
	tfmxFrameSize,
};

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

HippoPlaybackPlugin* getPlugin()
{
	return &g_tfmxPlugin;
}



